receivers:
  tracesimulationreceiver/send_message_request:
    global:
      interval: 5s
    blueprint:
      type: service
      service:
        default:
          startAfter: 0s
          duration: 1s
          failWith:
            probability: 0.1
        services:
          - name: ios_client
            resource:
              device.manufacturer: Apple
              service.version: v3
            tasks:
              - name: send_message_request
                id: ios_send_message_request
                kind: client
                duration: 2s
                failWith:
                  probability: 0.2

          - name: api_gateway
            resource:
              service.version: v2
            tasks:
              - name: receive_api_request
                id: api_receive_api_request
                kind: server
                childOf: ios_send_message_request
                startAfter: 50ms
                duration: 1.5s
                children:
                  - name: call_auth_service
                    id: call_auth_service
                    kind: client
                    startAfter: 30ms
                    duration: 120ms
                  - name: route_message_request
                    id: route_message_request
                    kind: client
                    startAfter: 200ms
                    duration: 1s

          - name: auth_service
            resource:
              service.version: v4
            tasks:
              - name: validate_user_session
                kind: server
                childOf: call_auth_service
                startAfter: 20ms
                duration: 100ms
                attributes:
                  http.target: /api/v1/session/validate
                  http.method: GET

          - name: message_write_server
            resource:
              service.version: v4
            tasks:
              - name: receive_write_request
                kind: server
                childOf: route_message_request
                startAfter: 50ms
                duration: 400ms
                children:
                  - name: produce_message_kafka
                    id: produce_message_kafka
                    kind: producer
                    startAfter: 80ms
                    duration: 150ms
                    attributes:
                      messaging.system: kafka
                      messaging.destination: message-topic
                      messaging.operation: publish

          - name: message_event_consumer
            resource:
              service.version: v2
              service.instance.id: message-event-consumer-1
            tasks:
              - name: consume_kafka_message
                kind: consumer
                startAfter: 1200ms
                linkedTo: [ produce_message_kafka ]
                attributes:
                  messaging.system: kafka
                  messaging.destination: message-topic
                children:
                  - name: update_read_model
                    kind: client
                    startAfter: 150ms
                    duration: 150ms
                    attributes:
                      db.operation: update_read_model
                      db.system: postgres
                      db.table: messages
                  - name: trigger_notification_event
                    id: trigger_notification_event-1
                    kind: producer
                    startAfter: 350ms
                    duration: 100ms
                    attributes:
                      messaging.operation: publish
                      messaging.system: kafka
                      messaging.destination: notification-topic

          - name: message_event_consumer
            resource:
              service.version: v2
              service.instance.id: message-event-consumer-2
            tasks:
              - name: consume_kafka_message
                kind: consumer
                startAfter: 1250ms
                linkedTo: [ produce_message_kafka ]
                attributes:
                  messaging.system: kafka
                  messaging.destination: message-topic
                children:
                  - name: update_read_model
                    kind: client
                    startAfter: 130ms
                    duration: 140ms
                    attributes:
                      db.operation: update_read_model
                      db.system: postgres
                      db.table: messages
                  - name: trigger_notification_event
                    id: trigger_notification_event-2
                    kind: producer
                    startAfter: 320ms
                    duration: 120ms
                    attributes:
                      messaging.operation: publish
                      messaging.system: kafka
                      messaging.destination: notification-topic

          - name: notification_service
            resource:
              service.version: v2
            tasks:
              - name: consume_notification
                kind: consumer
                startAfter: 1700ms
                duration: 150ms
                linkedTo: [ trigger_notification_event-1, trigger_notification_event-2 ]
                attributes:
                  messaging.system: kafka
                  messaging.destination: notification-topic
                children:
                  - name: send_email_notification
                    kind: client
                    startAfter: 100ms
                    duration: 130ms
                    attributes:
                      messaging.system: email-service

          - name: audit_service
            resource:
              service.version: v2
            tasks:
              - name: log_message_event
                kind: consumer
                startAfter: 2s
                duration: 120ms
                linkedTo: [ produce_message_kafka ]
                attributes:
                  messaging.system: kafka
                  messaging.destination: message-topic
                children:
                  - name: archive_message_event
                    kind: client
                    startAfter: 150ms
                    duration: 120ms
                    attributes:
                      rpc.service: S3
                      aws.s3.bucket: message-archive
                      aws.s3.key: str!! 2025-01-01

  tracesimulationreceiver/read_message_request:
    global:
      interval: 2s
    blueprint:
      type: service
      service:
        default:
          startAfter: 0s
          duration: 1s
          failWith:
            probability: 0.0
        services:
          - name: ios_client
            resource:
              device.manufacturer: Apple
              service.version: v3
            tasks:
              - name: read_message
                id: ios_read_message_request
                kind: client
                duration: 2s

          - name: api_gateway
            resource:
              service.version: v2
            tasks:
              - name: receive_read_request
                kind: server
                childOf: ios_read_message_request
                startAfter: 30ms
                duration: 1.5s
                children:
                  - name: call_auth_service_read
                    id: call_auth_service_read
                    kind: client
                    startAfter: 20ms
                    duration: 120ms
                  - name: route_message_read
                    id: route_message_read
                    kind: client
                    startAfter: 180ms
                    duration: 1s

          - name: auth_service
            resource:
              service.version: v4
            tasks:
              - name: validate_user_session_read
                kind: server
                childOf: call_auth_service_read
                startAfter: 10ms
                duration: 100ms
                attributes:
                  http.target: /api/v1/session/validate
                  http.method: GET

          - name: message_read_server
            resource:
              service.version: v1.0.0
            tasks:
              - name: receive_read_request_backend
                kind: server
                childOf: route_message_read
                startAfter: 50ms
                duration: 800ms
                children:
                  - name: redis_cache_lookup
                    kind: client
                    startAfter: 50ms
                    duration: 70ms
                    attributes:
                      db.system: redis
                      db.operation: get
                  - name: read_enriched_message
                    kind: client
                    startAfter: 300ms
                    duration: 120ms
                    attributes:
                      db.system: postgres
                      db.operation: select_enriched_message
                      db.table: messages
                  - name: send_read_response
                    kind: server
                    startAfter: 600ms
                    duration: 50ms

  tracesimulationreceiver/search_message_request_v1:
    global:
      interval: 15s
    blueprint:
      type: service
      service:
        default:
          startAfter: 0s
          duration: 1s
          failWith:
            probability: 0.2
        services:
          - name: ios_client
            resource:
              device.manufacturer: Apple
              service.version: v1
            tasks:
              - name: search_message_request
                id: ios_search_message_request
                kind: client
                duration: 2000ms

          - name: api_gateway
            resource:
              service.version: v2
            tasks:
              - name: receive_search_request
                id: api_receive_search_request
                kind: server
                childOf: ios_search_message_request
                startAfter: 30ms
                duration: 1.5s
                children:
                  - name: call_auth_service_search
                    id: call_auth_service_search
                    kind: client
                    startAfter: 20ms
                    duration: 110ms
                  - name: route_search_request
                    id: route_search_request
                    kind: client
                    startAfter: 180ms
                    duration: 650ms

          - name: auth_service
            resource:
              service.version: v4
            tasks:
              - name: validate_user_session_search
                kind: server
                childOf: call_auth_service_search
                startAfter: 10ms
                duration: 90ms
                attributes:
                  http.target: /api/v1/session/validate
                  http.method: GET

          - name: search_service
            resource:
              service.version: v2
            tasks:
              - name: perform_search
                kind: server
                childOf: route_search_request
                startAfter: 30ms
                duration: 550ms
                attributes:
                  db.system: elasticsearch
                  db.operation: search

  tracesimulationreceiver/search_message_request_v2:
    global:
      interval: 10s
    blueprint:
      type: service
      service:
        default:
          startAfter: 0s
          duration: 1s
          failWith:
            probability: 0.0
        services:
          - name: ios_client
            resource:
              device.manufacturer: Apple
              service.version: v2
            tasks:
              - name: search_message_request
                id: ios_search_message_request
                kind: client
                duration: 2s
                failWith:
                  probability: 0.8

          - name: api_gateway
            resource:
              service.version: v2
            tasks:
              - name: receive_search_request
                id: api_receive_search_request
                kind: server
                childOf: ios_search_message_request
                startAfter: 40ms
                duration: 1.5s
                children:
                  - name: call_auth_service_search
                    id: call_auth_service_search
                    kind: client
                    startAfter: 25ms
                    duration: 100ms
                  - name: route_search_request
                    id: route_search_request
                    kind: client
                    startAfter: 200ms
                    duration: 650ms

          - name: auth_service
            resource:
              service.version: v4
            tasks:
              - name: validate_user_session_search
                kind: server
                childOf: call_auth_service_search
                startAfter: 10ms
                duration: 90ms
                attributes:
                  http.target: /api/v1/session/validate
                  http.method: GET

          - name: search_service
            resource:
              service.version: v2
            tasks:
              - name: perform_search
                kind: server
                childOf: route_search_request
                startAfter: 40ms
                duration: 550ms
                attributes:
                  db.system: elasticsearch
                  db.operation: search

  tracesimulationreceiver/search_message_request_v3:
    global:
      interval: 5s
    blueprint:
      type: service
      service:
        default:
          startAfter: 0s
          duration: 1s
          failWith:
            probability: 0.01
        services:
          - name: ios_client
            resource:
              device.manufacturer: Apple
              service.version: v3
            tasks:
              - name: search_message_request
                id: ios_search_message_request
                kind: client
                duration: 2s

          - name: api_gateway
            resource:
              service.version: v2
            tasks:
              - name: receive_search_request
                id: api_receive_search_request
                kind: server
                childOf: ios_search_message_request
                startAfter: 30ms
                duration: 1.5s
                children:
                  - name: call_auth_service_search
                    id: call_auth_service_search
                    kind: client
                    startAfter: 20ms
                    duration: 100ms
                  - name: route_search_request
                    id: route_search_request
                    kind: client
                    startAfter: 190ms
                    duration: 650ms

          - name: auth_service
            resource:
              service.version: v4
            tasks:
              - name: validate_user_session_search
                kind: server
                childOf: call_auth_service_search
                startAfter: 10ms
                duration: 90ms
                attributes:
                  http.target: /api/v1/session/validate
                  http.method: GET

          - name: search_service
            resource:
              service.version: v2
            tasks:
              - name: perform_search
                kind: server
                childOf: route_search_request
                startAfter: 30ms
                duration: 550ms
                attributes:
                  db.system: elasticsearch
                  db.operation: search

  tracesimulationreceiver/payment_request:
    global:
      interval: 20s
    blueprint:
      type: service
      service:
        default:
          startAfter: 0s
          duration: 1s
          failWith:
            probability: 0.2
        services:
          - name: ios_client
            resource:
              device.manufacturer: Apple
              service.version: v3
            tasks:
              - name: payment_request
                id: ios_payment_request
                kind: client
                duration: 5000ms

          - name: payment_service
            resource:
              service.version: v2
            tasks:
              - name: process_payment
                kind: server
                childOf: ios_payment_request
                startAfter: 50ms
                duration: 3000ms
                children:
                  - name: call_stripe_api
                    kind: client
                    startAfter: 400ms
                    duration: 1000ms
                    attributes:
                      http.url: https://api.stripe.com/v1/charges
                      payment.gateway: stripe

connectors:
  datadog/connector:

processors:
  batch:
  resource:
    attributes:
      - key: deployment.environment.name
        value: demo
        action: insert

exporters:
  datadog:
    api:
      # Set the Datadog API key as an environment variable before running the collector
      key: ${env:DD_API_KEY}

service:
  pipelines:
    traces:
      receivers: [ tracesimulationreceiver/send_message_request, tracesimulationreceiver/read_message_request, tracesimulationreceiver/payment_request, tracesimulationreceiver/search_message_request_v1, tracesimulationreceiver/search_message_request_v2, tracesimulationreceiver/search_message_request_v3 ]
      processors: [ resource ]
      exporters: [ datadog/connector ]
    traces/2:
      receivers: [ datadog/connector ]
      processors: [ batch ]
      exporters: [ datadog ]
    metrics:
      receivers: [ datadog/connector ]
      processors: [ batch ]
      exporters: [ datadog ]
  telemetry:
    logs:
      level: info
